{% load issues_tags %}
<div class="area-top state-{{ current_issue.state }}">
    <header>
        <div class="repository-name">
            <a href="{{ current_repository.github_url }}" target="_blank" title="View on Github">
            {% if current_repository.private %}<i class="fa fa-lock" title="This repository is private"> </i>{% endif %}
            {{ current_issue.repository.full_name }}
            </a>
        </div>
        <div class="avatar">
            <img class="avatar-small img-circle" src="{{ current_issue.user.avatar_url|default:default_avatar }}" alt="{{ current_issue.user.username }}" title="Created by {{ current_issue.user.username }}">
        </div>
        <h3>
            {% if current_issue.number %}<a href="{{ current_issue.github_url }}" target="_blank" title="View this issue on Github"><span class="text-{{ current_issue.state }}">#{{ current_issue.number }}</span> -{% endif %}
            <span class="edit-place" data-field="title">
                {{ current_issue.title }}
            </span>
            {% if current_issue.number %}</a>{% endif %}
            {% if current_issue_edit_level %}<a href="{{ current_issue|edit_field_url:'title' }}" class="issue-edit-btn issue-edit-btn-title btn-loading" data-field="title" title="Edit the title"><i class="fa fa-edit"> </i><i class='fa fa-spinner fa-spin'> </i></a>{% endif %}
        </h3>
    </header>
    <section>
        <h5>Created by {{ current_issue.user.username }} on {{ current_issue.created_at|date:"DATETIME_FORMAT" }}</h5>
        {% if current_issue.number %}
            {% if current_issue.state == 'closed' %}
                <p class="state state-closed">Closed{% if current_issue.is_pull_request and current_issue.merged_at %}, and <strong>merged</strong>,{% endif %}{% if current_issue.closed_by %} by <img class="avatar-tiny img-circle" src="{{ current_issue.closed_by.avatar_url|default:default_avatar }}"> {{ current_issue.closed_by.username }}{% endif %} on {{ current_issue.closed_at|date:"DATETIME_FORMAT" }}{% if current_issues.updated_at > current_issue.closed_at %}, updated on {{ current_issue.updated_at|date:"DATETIME_FORMAT" }}{% endif %}</p>
            {% else %}
                {% if current_issue.updated_at and current_issue.created_at != current_issue.updated_at %}
                    <p class="state state-open">Updated on {{ current_issue.updated_at|date:"DATETIME_FORMAT" }}</p>
                {% endif %}
            {% endif %}
        {% endif %}
        {% if current_issue.is_pull_request %}<i class="fa fa-code issue-pull-request" title="It's a pull-request"> </i>{% endif %}
        {% if current_issue.milestone or current_issue_edit_level == 'full' %}
            <div class="issue-milestone{% if not current_issue.milestone %} no-milestone{% endif %} edit-place" data-field="milestone">
                {% if current_issue.milestone %}
                    <i class="fa fa-tasks text-{{ current_issue.milestone.state }}" title="{{ current_issue.milestone.state|capfirst }} milestone{% if current_issue.milestone.state == 'open' and current_issue.milestone.due_on %}, due on {{ current_issue.milestone.due_on|date:'DATE_FORMAT' }} {% endif %}"> </i> Milestone: <strong>{{ current_issue.milestone.title|truncatechars:30 }}</strong>
                {% else %}
                    <i class="fa fa-tasks"> </i> No milestone
                {% endif %}
                {% if current_issue_edit_level %}<a href="{{ current_issue|edit_field_url:'milestone' }}" class="issue-edit-btn issue-edit-btn-milestone btn-loading" data-field="milestone" title="Edit the milestone"><i class="fa fa-edit"> </i><i class='fa fa-spinner fa-spin'> </i></a>{% endif %}
            </div>
        {% endif %}
        {% if current_issue.assignee or current_issue_edit_level == 'full' %}
            <div class="issue-assignee{% if not current_issue.assignee %} no-assignee{% endif %} edit-place" data-field="assignee">
                {% if current_issue.assignee %}
                    <i class="fa fa-hand-o-right"> </i>&nbsp;<img class="avatar-tiny img-circle" src="{{ current_issue.assignee.avatar_url|default:default_avatar }}" /> Assigned to <strong>{{ current_issue.assignee.username }}</strong>
                {% else %}
                    <i class="fa fa-hand-o-right"> </i> No one assigned
                {% endif %}
                {% if current_issue_edit_level %}<a href="{{ current_issue|edit_field_url:'assignee' }}" class="issue-edit-btn issue-edit-btn-assignee btn-loading" data-field="assignee" title="Edit the assignee"><i class="fa fa-edit"> </i><i class='fa fa-spinner fa-spin'> </i></a>{% endif %}
            </div>
        {% endif %}
    </section>
    <footer>
        {% with labels=current_issue.labels.ready %}
            {% if labels|length or current_issue_edit_level == 'full' %}
                <div class="issue-labels edit-place" data-field="labels">
                    <ul class="unstyled">
                        {% if labels|length %}
                            {% for label in current_issue.labels.ready %}
                                {% if label.label_type_id %}
                                    <li style="border-bottom-color: #{{ label.color }}"><strong>{{ label.label_type.name }}:</strong> {{ label.typed_name }}</li>
                                {% endif %}
                            {% endfor %}
                            {% for label in current_issue.labels.ready %}
                                {% if not label.label_type_id %}
                                    <li style="border-bottom-color: #{{ label.color }}">{{ label.name }}</li>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <li style="border: none">No labels</li>
                        {% endif %}
                    </ul>
                    {% if current_issue_edit_level %}<a href="{{ current_issue|edit_field_url:'labels' }}" class="issue-edit-btn issue-edit-btn-labels btn-loading" data-field="labels" title="Edit the labels"><i class="fa fa-edit"> </i><i class='fa fa-spinner fa-spin'> </i></a>{% endif %}
                </div>
            {% endif %}
        {% endwith %}
        {% if current_issue.total_comments_count or current_issue_involved|length > 1  %}
            <div class="issue-footer-infos">
                <div>
                        <a class="issue-footer-info-part issue-comments-count" title="{{ current_issue.total_comments_count }} comment{{ current_issue.total_comments_count|pluralize }}" href="#issue-activity-{{ current_issue.number }}">
                            <i class="fa fa-comments-o"> </i> {{ current_issue.total_comments_count }}
                        </a>
                    {% if current_issue_involved|length > 1 %}
                        <div class="issue-footer-info-part">
                            <ul class="unstyled issue-involved">
                                {% for involved_user in current_issue_involved %}
                                    <li><img class="avatar-tiny img-circle" src="{{ involved_user.user.avatar_url|default:default_avatar }}" title="{{ involved_user.user.username }}{% if involved_user.types|length %} ({{ involved_user.types|join:", "}}){% endif %}{% if involved_user.comments %}, {{ involved_user.comments }} comment{{ involved_user.comments|pluralize }}{% endif %}{% if involved_user.commits %}, {{ involved_user.commits }} commit{{ involved_user.commits|pluralize }}{% endif %}"></li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </footer>
</div>
{% if current_issue.is_pull_request or current_issue_edit_level %}
    <div class="content issue-big-infos">
        {% if current_issue.is_pull_request %}
            {% if current_issue.pr_fetched_at %}
                <ul class="unstyled">
                    <li class="label label-blue" title="{{ current_issue.nb_commits }} commit{{ current_issue.nb_commits|pluralize }}"><i class="fa fa-git-square"></i> {{ current_issue.nb_commits }}</li>
                    <li class="label label-green" title="{{ current_issue.nb_additions }} addition{{ current_issue.nb_additions|pluralize }}"><i class="fa fa-plus"></i> {{ current_issue.nb_additions }}</li>
                    <li class="label label-red" title="{{ current_issue.nb_deletions }} deletion{{ current_issue.nb_deletions|pluralize }}"><i class="fa fa-minus"></i> {{ current_issue.nb_deletions }}</li>
                    <li class="label label-black" title="{{ current_issue.nb_changed_files }} changed file{{ current_issue.nb_changed_files|pluralize }}"><i class="fa fa-file-o"></i> {{ current_issue.nb_changed_files }}</li>
                </ul>
            {% endif %}
            <div>Pull request from <strong>{{ current_issue.head_label|default:current_issue.user.username }}</strong></div>
            {% if current_issue.pr_fetched_at %}
                <div class="pr-merge-status">
                    {% if current_issue.state == 'open' or not current_issue.merged %}
                        {# cannot reopen a merged-closed issue #}
                        {% include "front/repository/issues/include_issue_big_infos.html" %}
                    {% endif %}
                    {% if current_issue.state == 'open' %}
                        {% if current_issue.is_mergeable %}
                            <div class="alert alert-success"><strong>Can be merged</strong></div>
                        {% else %}
                            <div class="alert alert-error"><strong>Cannot be merged</strong>{% if current_issue.mergeable_state %} (reason: {{ current_issue.mergeable_state }}){% endif %}</div>
                        {% endif %}
                    {% else %}
                        {% if current_issue.merged %}
                            <div class="alert alert-success">Merged</div>
                        {% else %}
                            <div class="alert alert-error">Not merged</div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}
        {% elif current_issue_edit_level %}
            {% include "front/repository/issues/include_issue_big_infos.html" %}
        {% endif %}
    </div>
{% elif not current_issue.number %}
    <div class="content issue-big-infos">
        <p class="alert alert-warning">This issue is currently being pushed to github...</p>
    </div>
{% endif %}
