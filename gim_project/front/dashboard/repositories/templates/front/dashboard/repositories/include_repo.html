{% load frontutils %}
{% with repo_fullname=repo.owner|add:"/"|add:repo.name %}
    <tr data-repo="{{ repo_fullname }}" class="{% nospaces %}
        {% if repo_fullname in waiting_subscriptions %}
            {% with subscription=waiting_subscriptions|dict_item:repo_fullname %}
                {% if subscription.state == 3 %}
                    status-error
                {% else %}
                    status-warning
                {% endif %}
            {% endwith %}
        {% elif repo_fullname in subscriptions %}
            {% with subscription=subscriptions|dict_item:repo_fullname %}
                {% if subscription.state == 4 %}
                    status-error
                {% else %}
                    status-success
                {% endif %}
            {% endwith %}
        {% endif %}
    {% endnospaces %}">
        <td>
            {% if repo.owner != view.request.user.username and repo.owner != org.name %}
                <img class="avatar-micro img-circle" src="{{ repo.avatar_url|default:default_avatar }}" /><!--
            {% else %}<!--
            {% endif %}
            {% if repo_fullname in subscriptions %}
                {% with subscription=subscriptions|dict_item:repo_fullname %}
                    {% if subscription.state != 4 %}
                        --><a href="{{ subscription.repository.get_absolute_url }}" title="View this repository">{{ repo.owner }}/<strong>{{ repo.name }}</strong></a>
                    {% else %}
                        -->{{ repo.owner }}/<strong>{{ repo.name }}</strong>
                    {% endif %}
                {% endwith %}
            {% else %}
                -->{{ repo.owner }}/<strong>{{ repo.name }}</strong>
            {% endif %}
        </td>
        {% if repo_fullname in subscriptions %}
            {% with subscription=subscriptions|dict_item:repo_fullname %}
                <td><i class="icon-ok"> </i> <span class="smaller">({{ subscription.get_state_display|lower }})</span></td>
            {% endwith %}
        {% elif repo_fullname in waiting_subscriptions %}
            {% with subscription=waiting_subscriptions|dict_item:repo_fullname %}
                <td><i class="icon-spinner icon-spin"> </i> <span class="smaller">({{ subscription.get_state_display|lower }})</td>
            {% endwith %}
        {% else %}
            <td>&nbsp;</td>
        {% endif %}
        {% if repo.no_infos %}
            <td colspan="4">&nbsp;</td>
        {% else %}
            {% if repo.owner == view.request.user.username %}
                <td title="You are the owner of this repository"><i class="icon-user"> </i></td>
            {% else %}
                <td>&nbsp;</td>
            {% endif %}
            {% if repo.private %}
                <td title="This repository is private"><i class="icon-eye-close"> </i></td>
            {% else %}
                <td>&nbsp;</td>
            {% endif %}
            <td title="This repository{% if repo.is_fork %} is a fork and{% endif %} can have pull-requests {% if repo.has_issues %} and issues{% else %} but no issues{% endif %}">
                {% if repo.is_fork %}
                    <i class="icon-random"> </i>
                {% endif %}
                {% if repo.has_issues %}
                    <i class="icon-ok"> </i>
                {% else %}
                    <i class="icon-remove"> </i>
                {% endif %}
            </td>
            {% if repo.rights == "admin" %}
                <td title="You can admin this repository"><i class="icon-wrench"> </i></td>
            {% elif repo.rights == "push" %}
                <td title="You can work on this repository"><i class="icon-pencil"> </i></td>
            {% elif repo.rights == "read" %}
                <td title="You can read this repository"><i class="icon-eye-open"> </i></td>
            {% else %}
                <td>&nbsp;</td>
            {% endif %}
        {% endif %}
        {% if repo_fullname in waiting_subscriptions %}
            <td title="You already asked to subscribe to this repository">
                {% with subscription=waiting_subscriptions|dict_item:repo_fullname %}
                    {# {{ subscription.get_state_display }} #}
                    {% if subscription.can_add_again %}
                        <form action="{{ repository_add_url }}" method="post" class="toggle-form">
                            <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}' />
                            <input id="id_name" name="name" type="hidden" value="{{ repo_fullname }}" />
                            <button type="submit" class="btn btn-mini btn-green btn-loading" title="Subscribe to this repository again"><i class="icon-plus"> </i><i class='icon-spinner icon-spin'> </i></button>
                        </form>
                    {% endif %}
                    <form action="{{ repository_remove_url }}" method="post" class="toggle-form">
                        <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}' />
                        <input id="id_name" name="name" type="hidden" value="{{ repo_fullname }}" />
                        <button type="submit" class="btn btn-mini btn-red btn-loading" title="Cancel your subscription to this repository"><i class="icon-remove"> </i><i class='icon-spinner icon-spin'> </i></button>
                    </form>
                {% endwith %}
            </td>
        {% elif repo_fullname in subscriptions %}
            <td title="You already subscribed to this repository">
                {% with subscription=subscriptions|dict_item:repo_fullname %}
                    {# {{ subscription.get_state_display }} #}
                    <form action="{{ repository_remove_url }}" method="post" class="toggle-form">
                        <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}' />
                        <input id="id_name" name="name" type="hidden" value="{{ repo_fullname }}" />
                        <button type="submit" class="btn btn-mini btn-red btn-loading" title="Cancel your subscription to this repository"><i class="icon-remove"> </i><i class='icon-spinner icon-spin'> </i></button>
                    </form>
                {% endwith %}
            </td>
        {% else %}
            <td>
                <form action="{{ repository_add_url }}" method="post" class="toggle-form">
                    <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}' />
                    <input id="id_name" name="name" type="hidden" value="{{ repo_fullname }}" />
                    <button type="submit" class="btn btn-mini btn-green btn-loading" title="Subscribe to this repository"><i class="icon-plus"> </i><i class='icon-spinner icon-spin'> </i></button>
                </form>
            </td>
        {% endif %}
    </tr>
{% endwith %}
