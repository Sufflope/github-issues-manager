{% extends "front/base.html" %}
{% load frontutils %}

{% block title %}GIM's dashboard{% endblock title %}

{% block main %}
<div class="span12">
    <h1>So, you want to add a repository, {{ user.username }}</h1>

    <h2>Here is the list of repositories you can add:</h2>
    {% url "front:dashboard:repositories:add" as repository_add_url %}
    {% url "front:dashboard:repositories:remove" as repository_remove_url %}

    {% if available_repositories %}
        {% include "front/include_quicksearch.html" with target="#available-repositories tbody tr" content="td:first-child" only %}

        <table class="table table-normal" id="available-repositories">
            {% for org in available_repositories %}
                <thead>
                    <tr>
                        <th>{% if org.name == '__self__' %}Your (or others){% else %}{{ org.name }}'s{% endif %} repositories</th>
                        <th>Yours</th>
                        <th>Private</th>
                        <th>Admin</th>
                        <th>Add</th>
                    </tr>
                </thead>
                <tbody>
                    {% for repo in org.repos %}
                        {% with repo_fullname=repo.owner|add:"/"|add:repo.name %}
                            <tr class="{% nospaces %}
                                {% if repo_fullname in waiting_subscriptions %}
                                    {% with subscription=waiting_subscriptions|dict_item:repo_fullname %}
                                        {% if subscription.state == 3%}
                                            error
                                        {% else %}
                                            warning
                                        {% endif %}
                                    {% endwith %}
                                {% elif repo_fullname in subscriptions %}
                                    {% with subscription=subscriptions|dict_item:repo_fullname %}
                                        {% if subscription.state == 3%}
                                            error
                                        {% else %}
                                            success
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            {% endnospaces %}">
                                <td>
                                    {% if repo_fullname in subscriptions %}
                                        {% with subscription=subscriptions|dict_item:repo_fullname %}
                                            {% if subscription.state != 3 %}
                                                <a href="{{ subscription.repository.get_absolute_url }}" title="View this repository">{{ repo_fullname }}</a>
                                            {% else %}
                                                {{ repo_fullname }}
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        {{ repo_fullname }}
                                    {% endif %}
                                </td>
                                {% if repo.owner == user.username %}
                                    <td title="You are the owner of this repository"><i class="icon-user"> </i></td>
                                {% else %}
                                    <td>&nbsp;</td>
                                {% endif %}
                                {% if repo.private %}
                                    <td title="This repository is private"><i class="icon-eye-close"> </i></td>
                                {% else %}
                                    <td>&nbsp;</td>
                                {% endif %}
                                {% if repo.can_admin %}
                                    <td title="You can admin this repository"><i class="icon-wrench"> </i></td>
                                {% else %}
                                    <td>&nbsp;</td>
                                {% endif %}
                                {% if repo_fullname in waiting_subscriptions %}
                                    <td title="You already asked to add this repository">
                                        {% with subscription=waiting_subscriptions|dict_item:repo_fullname %}
                                            {{ subscription.get_state_display }}
                                            {% if subscription.can_add_again %}
                                                <form action="{{ repository_add_url }}" method="post">
                                                    <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}' />
                                                    <input id="id_name" name="name" type="hidden" value="{{ repo_fullname }}" />
                                                    <button type="submit" class="btn btn-mini" href="" title="Add this repository"><i class="icon-plus"> </i></button>
                                                </form>
                                            {% endif %}
                                            <form action="{{ repository_remove_url }}" method="post">
                                                <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}' />
                                                <input id="id_name" name="name" type="hidden" value="{{ repo_fullname }}" />
                                                <button type="submit" class="btn btn-mini" href="" title="Remove this repository"><i class="icon-remove"> </i></button>
                                            </form>
                                        {% endwith %}
                                    </td>
                                {% elif repo_fullname in subscriptions %}
                                    <td title="This repository is already added">
                                        {% with subscription=subscriptions|dict_item:repo_fullname %}
                                            {{ subscription.get_state_display }}
                                            <form action="{{ repository_remove_url }}" method="post">
                                                <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}' />
                                                <input id="id_name" name="name" type="hidden" value="{{ repo_fullname }}" />
                                                <button type="submit" class="btn btn-mini" href="" title="Remove this repository"><i class="icon-remove"> </i></button>
                                            </form>
                                        {% endwith %}
                                    </td>
                                {% else %}
                                    <td>
                                        <form action="{{ repository_add_url }}" method="post">
                                            <input type='hidden' name='csrfmiddlewaretoken' value='{{ csrf_token }}' />
                                            <input id="id_name" name="name" type="hidden" value="{{ repo_fullname }}" />
                                            <button type="submit" class="btn btn-mini" href="" title="Add this repository"><i class="icon-plus"> </i></button>
                                        </form>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endwith %}
                    {% endfor %}
                </tbody>
            {% endfor %}
        </table>
    {% else %}
        You have no repositories available to use !
    {% endif %}
</div>
{% endblock main %}
