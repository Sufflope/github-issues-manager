{% extends "front/repository/base.html" %}
{% load querystring frontutils %}

{% block main %}

<nav id="issues-nav" class="span2">

    <ul class="nav nav-list">

        {% if issues_filter %}
            <li><a href="{{ root_issues_url }}">Clear filters</a></li>
        {% else %}
            <li class="nav-header">Filter issues</li>
        {% endif %}
        <li class="divider"></li>


        <li class="nav-header" data-toggle="collapse" data-target="#filter-created">
            Creators
            {% if issues_filter.objects.current_created %}
                <span class="selection">{{ issues_filter.objects.current_created }}</span>
            {% endif %}
        </li>
        <li>
            <ul class="nav nav-list collapse" id="filter-created">
                {% for creator in issues_creators %}
                    {% if issues_filter.objects.current_created == creator.username %}
                        <li class="active"><a href="{{ root_issues_url }}{{ issues_filter.querystring }}">{{ creator }}</a></li>
                    {% else %}
                        <li><a href="{{ creator.created_filter_url }}{{ issues_filter.querystring }}">{{ creator }}</a></li>
                    {% endif %}
                {% endfor %}
            </ul>
        </li>
        <li class="divider"></li>


        <li class="nav-header" data-toggle="collapse" data-target="#filter-assigned">
            Assignees
            {% if issues_filter.objects.current_assigned %}
                <span class="selection">{% if issues_filter.objects.current_assigned == 'none' %}No one assigned{% else %}{{ issues_filter.objects.current_assigned }}{% endif %}</span>
            {% endif %}
        </li>
        <li>
            <ul class="nav nav-list collapse" id="filter-assigned">
                {% if issues_filter.objects.current_assigned == 'none' %}
                    <li class="active"><a href="{{ root_issues_url }}{{ issues_filter.querystring }}">No one assigned</a></li>
                {% else %}
                    <li><a href="{{ no_assigned_filter_url }}{{ issues_filter.querystring }}">No one assigned</a></li>
                {% endif %}
                {% for collaborator in collaborators %}
                    {% if issues_filter.objects.current_assigned == collaborator.username %}
                        <li class="active"><a href="{{ root_issues_url }}{{ issues_filter.querystring }}">{{ collaborator }}</a></li>
                    {% else %}
                        <li><a href="{{ collaborator.assigned_filter_url }}{{ issues_filter.querystring }}">{{ collaborator }}</a></li>
                    {% endif %}
                {% endfor %}
            </ul>
        </li>
        <li class="divider"></li>


        <li class="nav-header" data-toggle="collapse" data-target="#filter-state">
            State
            {% if issues_filter.objects.state %}
                <span class="selection">{{ issues_filter.objects.state }}</span>
            {% endif %}
        </li>
        <li>
            <ul class="nav nav-list collapse" id="filter-state">
                {% for state in view.allowed_states %}
                    <li{% toggle_value_if_in_querystring "state" state " class='active'" %}>
                        <a href="{{ current_issues_url }}{% toggle_in_querystring "state" state %}">{{ state|capfirst }}</a>
                    </li>
                {% endfor %}
            </ul>
        </li>
        <li class="divider"></li>


        <li class="nav-header" data-toggle="collapse" data-target="#filter-milestone">
            Milestone
            {% if issues_filter.objects.milestone %}
                <span class="selection">{% if issues_filter.objects.milestone == 'none' %}No milestone{% else %}{{ issues_filter.objects.milestone }}{% endif %}</span>
            {% endif %}
        </li>
        <li>
            <ul class="nav nav-list collapse" id="filter-milestone">
                <li{% toggle_value_if_in_querystring "milestone" "none" " class='active'" %}>
                    <a href="{{ current_issues_url }}{% toggle_in_querystring "milestone" "none" %}">No milestone</a>
                </li>
                {% for milestone in current_repository.milestones.all %}
                    <li{% toggle_value_if_in_querystring "milestone" milestone.number " class='active'" %}>
                        <a href="{{ current_issues_url }}{% toggle_in_querystring "milestone" milestone.number %}">{{ milestone }}</a>
                    </li>
                {% endfor %}
            </ul>
        </li>
        <li class="divider"></li>


        {% for label_type in current_repository.label_types.all %}
            {% with label_type.labels.all as label_type_labels %}
                {% if label_type_labels|length %}
                    <li class="nav-header" data-toggle="collapse" data-target="#filter-label-type-{{ label_type.id }}">
                        {{ label_type.name }}
                        {% with current_label_type=issues_filter.objects.current_label_types|dict_item:label_type.id %}
                            {% if current_label_type %}
                                <span class="selection">{{ current_label_type.typed_name }}</span>
                            {% endif %}
                        {% endwith %}
                    </li>
                    <li>
                        <ul class="nav nav-list collapse" id="filter-label-type-{{ label_type.id }}">
                            {% attributes_for_list label_type_labels "name" as label_names %}
                            {% for label in label_type_labels %}
                                <li{% toggle_value_if_in_querystring "labels" label.name " class='active'" %}>
                                    <a href="{{ current_issues_url }}{% toggle_one_from_querystring "labels" label.name remove_values=label_names %}" title="{{ label.name }}">{{ label.typed_name }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                    <li class="divider"></li>
                {% endif %}
            {% endwith %}
        {% endfor %}


        {% with untyped_labels=current_repository.untyped_labels.all %}
            {% if untyped_labels|length %}
                <li class="nav-header" data-toggle="collapse" data-target="#filter-labels">
                    Labels
                    {% if issues_filter.objects.current_labels %}
                        {% attributes_for_list issues_filter.objects.current_labels "name" as current_label_names %}
                        <span class="selection">{{ current_label_names|join:", " }}</span>
                    {% endif %}
                </li>
                <li>
                    <ul class="nav nav-list collapse" id="filter-labels">
                        {% for label in untyped_labels %}
                            <li{% toggle_value_if_in_querystring "labels" label.name " class='active'" %}>
                                <a href="{{ current_issues_url }}{% toggle_one_from_querystring "labels" label.name %}">{{ label.name }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
                <li class="divider"></li>
            {% endif %}
        {% endwith %}

    </ul>

</nav>

<section id="issues-list" class="span4">
    {% if issues %}
        <div id="issues-list-sort-and-group" class="row">
            <div class="btn-group span6">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    Sort
                    <span class="caret"></span>
                    {% if issues_filter.parts.sort %}
                        <span class="selection">
                            {{ issues_filter.parts.sort|capfirst }}
                            ({{ issues_filter.parts.direction|capfirst }}.)
                        </span>
                    {% endif %}
                </a>
                <ul class="dropdown-menu">
                    {% if issues_filter.parts.sort %}
                        <li class="sort-menu{% toggle_value_if_in_querystring "direction" "asc" if_true=" active" %}">
                            <a href="{{ current_issues_url }}{% replace_in_querystring "direction" "asc" %}">Asc.</a>
                        </li><!--
                        --><li class="sort-menu{% toggle_value_if_in_querystring "direction" "desc" if_true=" active" %}">
                            <a href="{{ current_issues_url }}{% replace_in_querystring "direction" "desc" %}">Desc.</a>
                        </li>
                        <li class="divider"></li>
                    {% endif %}
                    {% for sort_field in view.allowed_sort_fields %}
                        <li{% toggle_value_if_in_querystring "sort" sort_field if_true=" class='active'" %}>
                            <a href="{{ current_issues_url }}{% replace_many_in_querystring "sort" sort_field "direction" issues_filter.parts.direction|default:"desc" %}">{{ sort_field|capfirst }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="btn-group span6">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    Group by
                    <span class="caret"></span>
                    <span class="selection">
                        {% if issues_filter.parts.group_by %}
                            {% if issues_filter.objects.group_by_field == 'label_type_grouper' %}
                                {{ issues_filter.objects.group_by.name|capfirst }}
                            {% else %}
                                {{ issues_filter.parts.group_by|capfirst }}
                            {% endif %}
                            ({{ issues_filter.parts.group_by_direction|capfirst }}.)
                        {% else %}
                            No group by
                        {% endif %}
                    </span>
                </a>
                <ul class="dropdown-menu pull-right">
                    {% if issues_filter.parts.group_by %}
                        <li class="sort-menu{% toggle_value_if_in_querystring "group_by_direction" "asc" if_true=" active" %}">
                            <a href="{{ current_issues_url }}{% replace_in_querystring "group_by_direction" "asc" %}">Asc.</a>
                        </li><!--
                        --><li class="sort-menu{% toggle_value_if_in_querystring "group_by_direction" "desc" if_true=" active" %}">
                            <a href="{{ current_issues_url }}{% replace_in_querystring "group_by_direction" "desc" %}">Desc.</a>
                        </li>
                        <li class="divider"></li>
                    {% endif %}
                    {% for group_by_field in view.allowed_group_by_fields %}
                        <li{% toggle_value_if_in_querystring "group_by" group_by_field " class='active'" %}>
                            <a href="{{ current_issues_url }}{% toggle_in_querystring "group_by" group_by_field %}">{{ group_by_field|capfirst }}</a>
                        </li>
                    {% endfor %}
                    {% with current_repository.label_types.all as label_types %}
                        {% if label_types|length %}
                            <li class="divider"></li>
                            {% for label_type in label_types %}
                                {% with "type:"|add:label_type.name as label_type_group_name %}
                                    {% if label_type.labels.count %}
                                        <li{% toggle_value_if_in_querystring "group_by" label_type_group_name " class='active'" %}>
                                            <a href="{{ current_issues_url }}{% toggle_in_querystring "group_by" label_type_group_name %}">{{ label_type.name }}</a>
                                        </li>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                </ul>
            </div>
        </div>
        <div>
            {% dynamic_regroup issues by issues_filter.objects.group_by_field as issues_groups %}
            {% for group in issues_groups %}
                <div>
                    {% if issues_filter.objects.group_by_field %}<h3>{{ group.grouper }} ({{ group.list|length }})</h3>{% endif %}
                    <ul class="unstyled">
                        {% for issue in group.list %}
                            <li class="well well-small{% if current_issue.id == issue.id %} active{% endif %}">
                                <a href="{{ issue.get_absolute_url }}{{ issues_filter.querystring_with_user|default:issues_filter.querystring }}">
                                    <strong>#{{ issue.number }}</strong> - {{ issue.title }}
                                </a>
                                <div>
                                    <span class="label label-{% if issue.state == 'open' %}success{% else %}important{% endif %}">{{ issue.state }}</span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
            </ul>
        </div>
    {% else %}
        <p class="empty-column">Nothing :(</p>
    {% endif %}
</section>

<section id="issue" class="span6">
    {% if current_issue %}
        <article>
            <h3>#{{ current_issue.number }} - {{ current_issue.title }}</h3>
            <div class="well">
                {{ current_issue.body|safe }}
            </div>
        </article>
        <aside>
            <h4>Comments</h4>
            <ul>
                {% for comment in current_issue.comments.all %}
                    <li>{{ comment.body }}</li>
                {% endfor %}
            </ul>
        </aside>
    {% else %}
        <p class="empty-column">{% if current_issue_state == 'notfound' %}404 :({% else %}...{% endif %}</p>
    {% endif %}
</section>

{% endblock main %}
