{% extends "front/repository/base.html" %}
{% load querystring %}

{% block main %}

<nav id="issues-nav" class="span2">

    <ul class="nav nav-list">

        {% if issues_filter %}
            <li><a href="{{ root_issues_url }}">Clear filters</a></li>
        {% else %}
            <li class="nav-header">Filter issues</li>
        {% endif %}
        <li class="divider"></li>


        <li class="nav-header">Creators</li>
        {% for creator in issues_creators %}
            <li{% if current_created == creator.username %} class="active"{% endif %}><a href="{{ creator.created_filter_url }}{{ issues_filter.querystring }}">{{ creator }}</a></li>
        {% endfor %}
        <li class="divider"></li>


        <li class="nav-header">Assignees</li>
        <li{% if current_assigned == 'none' %} class="active"{% endif %}><a href="{{ no_assigned_filter_url }}{{ issues_filter.querystring }}">No one assigned</a></li>
        {% for collaborator in collaborators %}
            <li{% if current_assigned == collaborator.username %} class="active"{% endif %}><a href="{{ collaborator.assigned_filter_url }}{{ issues_filter.querystring }}">{{ collaborator }}</a></li>
        {% endfor %}
        <li class="divider"></li>


        <li class="nav-header">State</li>
        <li{% toggle_value_if_in_querystring "state" "open" " class='active'" %}>
            <a href="{{ current_issues_url }}{% toggle_in_querystring "state" "open" %}">Open</a>
        </li>
        <li{% toggle_value_if_in_querystring "state" "closed" " class='active'" %}>
            <a href="{{ current_issues_url }}{% toggle_in_querystring "state" "closed" %}">Closed</a>
        </li>
        <li class="divider"></li>


        <li class="nav-header">Milestone</li>
        <li{% toggle_value_if_in_querystring "milestone" "none" " class='active'" %}><a href="{{ current_issues_url }}{% toggle_in_querystring "milestone" "none" %}">No milestone</a></li>
        {% for milestone in current_repository.milestones.all %}
            <li{% toggle_value_if_in_querystring "milestone" milestone.number " class='active'" %}>
                <a href="{{ current_issues_url }}{% toggle_in_querystring "milestone" milestone.number %}">{{ milestone }}</a>
            </li>
        {% endfor %}
        <li class="divider"></li>


        {% for label_type in current_repository.label_types.all %}
            <li class="nav-header">{{ label_type.name }}</li>
            {% for label in label_type.labels.all %}
                <li{% toggle_value_if_in_querystring "labels" label.name " class='active'" %}>
                    <a href="{{ current_issues_url }}{% toggle_one_from_querystring "labels" label.name %}" title="{{ label.name }}">{{ label.typed_name }}</a>
                </li>
            {% endfor %}
            <li class="divider"></li>
        {% endfor %}


        {% with untyped_labels=current_repository.untyped_labels.all %}
            {% if untyped_labels|length %}
                <li class="nav-header">Labels</li>
                {% for label in untyped_labels %}
                    <li{% toggle_value_if_in_querystring "labels" label.name " class='active'" %}>
                        <a href="{{ current_issues_url }}{% toggle_one_from_querystring "labels" label.name %}">{{ label.name }}</a>
                    </li>
                {% endfor %}
                <li class="divider"></li>
            {% endif %}
        {% endwith %}

    </ul>

</nav>

<section id="issues-list" class="span4">
    {% if issues %}
        <ul class="unstyled">
            {% for issue in issues %}
                <li class="well well-small{% if current_issue.id == issue.id %} active{% endif %}">
                    <a href="{{ issue.get_absolute_url }}{{ issues_filter.querystring_with_user_filter }}">
                        <strong>#{{ issue.number }}</strong> - {{ issue.title }}
                    </a>
                    <div>
                        <span class="label label-{% if issue.state == 'open' %}success{% else %}important{% endif %}">{{ issue.state }}</span>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="empty-column">Nothing :(</p>
    {% endif %}
</section>

<section id="issue" class="span6">
    {% if current_issue %}
        <article>
            <h3>{{ current_issue }}</h3>
            <div class="well">
                {{ current_issue.body|safe }}
            </div>
        </article>
        <aside>
            <h4>Comments</h4>
            <ul>
                {% for comment in current_issue.comments.all %}
                    <li>{{ comment.body }}</li>
                {% endfor %}
            </ul>
        </aside>
    {% else %}
        <p class="empty-column">{% if current_issue_state == 'notfound' %}404 :({% else %}...{% endif %}</p>
    {% endif %}
</section>

{% endblock main %}
